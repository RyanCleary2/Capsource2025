<div class="max-w-6xl mx-auto p-6">
  <!-- Flash Messages -->
  <% if notice %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6" role="alert">
      <span class="block sm:inline"><%= notice %></span>
    </div>
  <% end %>

  <% if alert %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6" role="alert">
      <span class="block sm:inline"><%= alert %></span>
    </div>
  <% end %>

  <!-- Header -->
  <div class="mb-8">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-4xl font-bold text-capsource-dark mb-2">Extracted Profile Data</h1>
        <p class="text-capsource-mauve">Review and verify your extracted professional information</p>
        <%= link_to "← Upload Another Resume", root_path, class: "inline-block mt-4 text-capsource-orange hover:text-capsource-dark transition-colors" %>
      </div>
      <div class="flex space-x-3">
        <button id="edit-btn" class="capsource-button bg-capsource-purple hover:bg-opacity-90 rounded-lg px-6 py-3">
          <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Edit
        </button>
        <button id="save-btn" class="hidden capsource-button bg-green-600 hover:bg-green-700 rounded-lg px-6 py-3">
          <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Save Changes
        </button>
        <button id="cancel-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white rounded-lg px-6 py-3">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <%= form_with url: update_profile_path, method: :patch, local: true, class: "space-y-8", id: "profile-form" do |form| %>
    <!-- Personal Information -->
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        Personal Information
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-capsource-dark mb-2">Full Name</label>
          <div class="display-field">
            <p class="text-lg text-gray-800 bg-gray-50 p-3 rounded"><%= @profile_data["personalInfo"]["fullName"] %></p>
          </div>
          <div class="edit-field hidden">
            <%= form.text_field "personalInfo[fullName]", value: @profile_data["personalInfo"]["fullName"], class: "w-full text-lg p-3 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-capsource-dark mb-2">Email</label>
          <div class="display-field">
            <p class="text-lg text-gray-800 bg-gray-50 p-3 rounded"><%= @profile_data["personalInfo"]["email"] %></p>
          </div>
          <div class="edit-field hidden">
            <%= form.email_field "personalInfo[email]", value: @profile_data["personalInfo"]["email"], class: "w-full text-lg p-3 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-capsource-dark mb-2">Phone</label>
          <div class="display-field">
            <p class="text-lg text-gray-800 bg-gray-50 p-3 rounded"><%= @profile_data["personalInfo"]["phone"] %></p>
          </div>
          <div class="edit-field hidden">
            <%= form.text_field "personalInfo[phone]", value: @profile_data["personalInfo"]["phone"], class: "w-full text-lg p-3 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-capsource-dark mb-2">Location</label>
          <div class="display-field">
            <p class="text-lg text-gray-800 bg-gray-50 p-3 rounded"><%= @profile_data["personalInfo"]["location"] %></p>
          </div>
          <div class="edit-field hidden">
            <%= form.text_field "personalInfo[location]", value: @profile_data["personalInfo"]["location"], class: "w-full text-lg p-3 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-capsource-dark mb-2">Website</label>
          <div class="display-field">
            <p class="text-lg text-gray-800 bg-gray-50 p-3 rounded"><%= @profile_data["personalInfo"]["website"] %></p>
          </div>
          <div class="edit-field hidden">
            <%= form.url_field "personalInfo[website]", value: @profile_data["personalInfo"]["website"], class: "w-full text-lg p-3 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-capsource-dark mb-2">LinkedIn</label>
          <div class="display-field">
            <p class="text-lg text-gray-800 bg-gray-50 p-3 rounded"><%= @profile_data["personalInfo"]["linkedin"] %></p>
          </div>
          <div class="edit-field hidden">
            <%= form.text_field "personalInfo[linkedin]", value: @profile_data["personalInfo"]["linkedin"], class: "w-full text-lg p-3 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Professional Summary -->
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-4">Professional Summary</h2>
      <div class="display-field">
        <p class="text-lg text-gray-800 bg-gray-50 p-4 rounded leading-relaxed"><%= @profile_data["professionalSummary"] %></p>
      </div>
      <div class="edit-field hidden">
        <%= form.text_area "professionalSummary", value: @profile_data["professionalSummary"], rows: 4, class: "w-full text-lg p-4 border border-gray-300 rounded focus:ring-2 focus:ring-capsource-orange focus:border-transparent" %>
      </div>
    </div>

    <!-- Experience -->
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v2a2 2 0 002 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2v-8a2 2 0 012-2V6"></path>
        </svg>
        Experience
      </h2>

      <div class="space-y-6">
        <% @profile_data["experience"].each do |exp| %>
          <div class="border-l-4 border-capsource-orange pl-6 pb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
              <h3 class="text-xl font-semibold text-capsource-dark"><%= exp["title"] %></h3>
              <span class="text-capsource-mauve font-medium"><%= exp["startDate"] %> - <%= exp["endDate"] %></span>
            </div>
            <p class="text-lg text-capsource-purple font-medium mb-2"><%= exp["company"] %> • <%= exp["location"] %></p>
            <p class="text-gray-700 mb-4"><%= exp["description"] %></p>

            <% if exp["keyAchievements"].any? %>
              <div>
                <h4 class="font-medium text-capsource-dark mb-2">Key Achievements:</h4>
                <ul class="list-disc list-inside space-y-1">
                  <% exp["keyAchievements"].each do |achievement| %>
                    <li class="text-gray-700"><%= achievement %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Education -->
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
        </svg>
        Education
      </h2>

      <div class="space-y-4">
        <% @profile_data["education"].each do |edu| %>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-2">
              <h3 class="text-xl font-semibold text-capsource-dark"><%= edu["degree"] %></h3>
              <span class="text-capsource-mauve font-medium"><%= edu["graduationYear"] %></span>
            </div>
            <p class="text-lg text-capsource-purple font-medium mb-2"><%= edu["institution"] %></p>
            <div class="flex space-x-4">
              <% if edu["gpa"] %>
                <span class="text-gray-700"><strong>GPA:</strong> <%= edu["gpa"] %></span>
              <% end %>
              <% if edu["honors"] %>
                <span class="text-gray-700"><strong>Honors:</strong> <%= edu["honors"] %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Skills -->
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
        </svg>
        Skills
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div>
          <h3 class="text-lg font-medium text-capsource-dark mb-3">Technical Skills</h3>
          <div class="flex flex-wrap gap-2">
            <% @profile_data["skills"]["technical"].each do |skill| %>
              <span class="skill-tag technical-skill"><%= skill %></span>
            <% end %>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-medium text-capsource-dark mb-3">Soft Skills</h3>
          <div class="flex flex-wrap gap-2">
            <% @profile_data["skills"]["soft"].each do |skill| %>
              <span class="skill-tag soft-skill"><%= skill %></span>
            <% end %>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-medium text-capsource-dark mb-3">Languages</h3>
          <div class="flex flex-wrap gap-2">
            <% @profile_data["skills"]["languages"].each do |language| %>
              <span class="skill-tag language-skill"><%= language %></span>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Certifications -->
    <% if @profile_data["certifications"].any? %>
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-6">Certifications</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% @profile_data["certifications"].each do |cert| %>
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="font-semibold text-capsource-dark"><%= cert["name"] %></h3>
            <p class="text-capsource-purple"><%= cert["issuer"] %></p>
            <p class="text-capsource-mauve"><%= cert["date"] %></p>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>

    <!-- Projects -->
    <% if @profile_data["projects"].any? %>
    <div class="capsource-card rounded-lg p-6">
      <h2 class="text-2xl font-semibold text-capsource-dark mb-6">Projects</h2>
      <div class="space-y-4">
        <% @profile_data["projects"].each do |project| %>
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-xl font-semibold text-capsource-dark mb-2"><%= project["name"] %></h3>
            <p class="text-gray-700 mb-3"><%= project["description"] %></p>
            <div class="flex flex-wrap gap-2">
              <% project["technologies"].each do |tech| %>
                <span class="skill-tag technical-skill"><%= tech %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>

    <!-- Actions -->
    <div class="text-center">
      <%= link_to "Upload Another Resume", root_path, class: "capsource-button rounded-lg px-8 py-4 text-lg" %>
    </div>
  <% end %>
</div>

<script>
(function() {
  'use strict';

  console.log('Edit functionality script loading...');

  function initializeEditFunctionality() {
    console.log('Initializing edit functionality');

    // Get elements
    const editBtn = document.getElementById('edit-btn');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const profileForm = document.getElementById('profile-form');

    console.log('Elements check:', {
      editBtn: !!editBtn,
      saveBtn: !!saveBtn,
      cancelBtn: !!cancelBtn,
      profileForm: !!profileForm
    });

    if (!editBtn) {
      console.error('Edit button not found!');
      return;
    }

    // Store original values for cancel functionality
    let originalValues = {};

    function storeOriginalValues() {
      const inputs = document.querySelectorAll('.edit-field input, .edit-field textarea');
      inputs.forEach(input => {
        originalValues[input.name] = input.value;
      });
      console.log('Stored original values:', Object.keys(originalValues).length, 'fields');
    }

    function enterEditMode() {
      console.log('Entering edit mode');

      // Store original values
      storeOriginalValues();

      // Hide display fields, show edit fields
      document.querySelectorAll('.display-field').forEach(field => {
        field.style.display = 'none';
      });

      document.querySelectorAll('.edit-field').forEach(field => {
        field.style.display = 'block';
        field.classList.remove('hidden');
      });

      // Toggle buttons
      editBtn.style.display = 'none';
      if (saveBtn) {
        saveBtn.style.display = 'inline-flex';
        saveBtn.classList.remove('hidden');
      }
      if (cancelBtn) {
        cancelBtn.style.display = 'inline-flex';
        cancelBtn.classList.remove('hidden');
      }

      console.log('Edit mode activated');
    }

    function exitEditMode() {
      console.log('Exiting edit mode');

      // Show display fields, hide edit fields
      document.querySelectorAll('.display-field').forEach(field => {
        field.style.display = 'block';
      });

      document.querySelectorAll('.edit-field').forEach(field => {
        field.style.display = 'none';
        field.classList.add('hidden');
      });

      // Toggle buttons
      editBtn.style.display = 'inline-flex';
      if (saveBtn) {
        saveBtn.style.display = 'none';
        saveBtn.classList.add('hidden');
      }
      if (cancelBtn) {
        cancelBtn.style.display = 'none';
        cancelBtn.classList.add('hidden');
      }

      console.log('Edit mode deactivated');
    }

    function restoreOriginalValues() {
      const inputs = document.querySelectorAll('.edit-field input, .edit-field textarea');
      inputs.forEach(input => {
        if (originalValues[input.name] !== undefined) {
          input.value = originalValues[input.name];
        }
      });
      console.log('Restored original values');
    }

    // Event listeners
    editBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Edit button clicked');
      enterEditMode();
    });

    if (cancelBtn) {
      cancelBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Cancel button clicked');
        restoreOriginalValues();
        exitEditMode();
      });
    }

    if (saveBtn && profileForm) {
      saveBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Save button clicked - submitting form');
        profileForm.submit();
      });
    }

    console.log('Edit functionality initialized successfully');
  }

  // Try to initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEditFunctionality);
  } else {
    // DOM is already ready
    setTimeout(initializeEditFunctionality, 100);
  }

  // Fallback: try again when window loads
  window.addEventListener('load', function() {
    setTimeout(initializeEditFunctionality, 200);
  });

})();
</script>